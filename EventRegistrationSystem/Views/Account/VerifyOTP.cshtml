@model EventRegistrationSystem.ViewModel.VerifyOTPViewModel

@{
    ViewData["Title"] = "Verify OTP";
    Layout = "_Layout";
}

<div class="min-h-screen bg-slate-50 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full">

        <!-- Main Card -->
        <div class="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">

            <!-- Gradient Header -->
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 px-6 py-5">
                <h1 class="text-2xl font-bold text-white">Verify OTP</h1>
                <p class="text-indigo-100 text-sm mt-1">Enter the 6-digit code sent to your email</p>
            </div>

            <!-- Alert Messages -->
            @if (TempData["Success"] != null)
            {
                <div class="mx-6 mt-6 bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg flex items-center">
                    <i class="fas fa-check-circle text-green-500 mr-2"></i>
                    @TempData["Success"]
                </div>
            }
            @if (TempData["Error"] != null)
            {
                <div class="mx-6 mt-6 bg-rose-50 border border-rose-200 text-rose-600 px-4 py-3 rounded-lg flex items-center">
                    <i class="fas fa-exclamation-circle text-rose-500 mr-2"></i>
                    @TempData["Error"]
                </div>
            }

            <!-- Form -->
            <div class="p-6">
                <div class="mb-6 text-center">
                    <p class="text-slate-600 text-sm">
                        We've sent a 6-digit verification code to
                    </p>
                    <p class="font-semibold text-slate-800 mt-1 bg-slate-100 inline-block px-4 py-2 rounded-lg">
                        <i class="fas fa-envelope text-indigo-500 mr-2"></i>@Model.Email
                    </p>
                </div>

                <form asp-action="VerifyOTP" method="post" id="otpForm" class="space-y-6">
                    @Html.AntiForgeryToken()
                    <input type="hidden" asp-for="Email" />

                    <!-- Validation Summary -->
                    <div asp-validation-summary="All" class="text-sm text-rose-600 bg-rose-50 border border-rose-200 rounded-lg p-3"></div>

                    <!-- OTP Input -->
                    <div class="space-y-2">
                        <label asp-for="OTP" class="block text-sm font-semibold text-slate-700">
                            OTP Code <span class="text-rose-500">*</span>
                        </label>
                        <div class="relative">
                            <input asp-for="OTP"
                                   id="otpInput"
                                   class="w-full px-4 py-4 text-center text-2xl font-mono tracking-[0.5em] border border-slate-300 rounded-xl focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500 transition shadow-sm"
                                   placeholder="• • • • • •"
                                   maxlength="6"
                                   autofocus />
                        </div>
                        <span asp-validation-for="OTP" class="text-sm text-rose-600"></span>
                    </div>

                    <!-- Verify Button -->
                    <button type="submit"
                            class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-semibold py-3 px-6 rounded-xl hover:from-indigo-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all shadow-md hover:shadow-lg">
                        <i class="fas fa-check-circle mr-2"></i>Verify OTP
                    </button>
                </form>

                <!-- Resend OTP Section -->
                <div class="mt-8 text-center border-t border-slate-200 pt-6">
                    <p class="text-slate-600 text-sm mb-3">Didn't receive the code?</p>

                    @if (Model.CanResend)
                    {
                        <form asp-action="ResendOTP" method="post" class="inline">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="email" value="@Model.Email" />
                            <button type="submit"
                                    class="inline-flex items-center px-6 py-2.5 bg-indigo-50 text-indigo-700 rounded-xl font-medium hover:bg-indigo-100 transition shadow-sm border border-indigo-200">
                                <i class="fas fa-redo-alt mr-2"></i>Resend OTP
                            </button>
                        </form>
                    }
                    else
                    {
                        <!-- 👇 DATA ATTRIBUTES – all server values passed here -->
                        <div id="countdown-container"
                             data-seconds="@ViewBag.SecondsRemaining"
                             data-email="@Model.Email"
                             data-resend-url="@Url.Action("ResendOTP")"
                             data-antiforgery-token="@Html.AntiForgeryToken()">
                            <button id="resendBtn"
                                    class="inline-flex items-center px-6 py-2.5 bg-slate-100 text-slate-500 rounded-xl font-medium cursor-not-allowed border border-slate-200"
                                    disabled>
                                <i class="fas fa-redo-alt mr-2"></i>Resend OTP
                            </button>
                            <div id="countdown" class="mt-3 text-sm font-medium text-rose-600"></div>
                        </div>
                    }

                    <!-- Back to Login -->
                    <div class="mt-6">
                        <a asp-action="Login"
                           class="text-sm text-indigo-600 hover:text-indigo-500 font-medium inline-flex items-center">
                            <i class="fas fa-arrow-left mr-1"></i>Back to Login
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <p class="mt-6 text-center text-xs text-slate-500">
            &copy; @DateTime.Now.Year EventFlow – Secure OTP verification
        </p>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        (function() {
            "use strict";

            // ----- OTP INPUT AUTO-FOCUS & AUTO-SUBMIT -----
            const otpInput = document.getElementById('otpInput');
            const otpForm = document.getElementById('otpForm');

            if (otpInput) {
                otpInput.focus();

                otpInput.addEventListener('input', function(e) {
                    this.value = this.value.replace(/[^0-9]/g, '');
                    if (this.value.length === 6 && otpForm) {
                        otpForm.submit();
                    }
                });
            }

            // ----- COUNTDOWN TIMER (READS DATA ATTRIBUTES) -----
            const container = document.getElementById('countdown-container');
            if (container) {
                const secondsRemaining = parseInt(container.dataset.seconds, 10);
                const email = container.dataset.email;
                const resendUrl = container.dataset.resendUrl;
                const tokenHtml = container.dataset.antiforgeryToken;

                if (secondsRemaining > 0) {
                    const countdownEl = document.getElementById('countdown');
                    const resendBtn = document.getElementById('resendBtn');
                    let secondsLeft = secondsRemaining;

                    function updateCountdown() {
                        if (!countdownEl || !resendBtn) return;

                        if (secondsLeft <= 0) {
                            countdownEl.textContent = 'You can now resend OTP.';

                            // Create active resend form
                            const newForm = document.createElement('form');
                            newForm.method = 'post';
                            newForm.action = resendUrl;
                            newForm.className = 'inline';

                            // Extract anti‑forgery token value from the HTML string
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = tokenHtml;
                            const tokenInput = tempDiv.querySelector('input[name="__RequestVerificationToken"]');
                            if (tokenInput) {
                                newForm.appendChild(tokenInput.cloneNode(true));
                            }

                            const emailInput = document.createElement('input');
                            emailInput.type = 'hidden';
                            emailInput.name = 'email';
                            emailInput.value = email;

                            const button = document.createElement('button');
                            button.type = 'submit';
                            button.className = 'inline-flex items-center px-6 py-2.5 bg-indigo-50 text-indigo-700 rounded-xl font-medium hover:bg-indigo-100 transition shadow-sm border border-indigo-200';
                            button.innerHTML = '<i class="fas fa-redo-alt mr-2"></i>Resend OTP';

                            newForm.appendChild(emailInput);
                            newForm.appendChild(button);
                            resendBtn.parentNode.innerHTML = '';
                            resendBtn.parentNode.appendChild(newForm);
                            return;
                        }

                        const minutes = Math.floor(secondsLeft / 60);
                        const seconds = secondsLeft % 60;
                        countdownEl.textContent = `Resend available in: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                        secondsLeft--;
                        setTimeout(updateCountdown, 1000);
                    }

                    updateCountdown();
                }
            }
        })();
    </script>
}