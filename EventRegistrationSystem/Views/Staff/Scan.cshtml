@{
    ViewData["Title"] = "QR Scanner";
    Layout = "_StaffLayout";
}

<div class="min-h-screen bg-slate-50 py-4 px-3">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-4 sm:p-6">
            <h1 class="text-xl sm:text-2xl font-bold text-slate-800 mb-3 sm:mb-4">QR Code Scanner</h1>
            <p class="text-sm sm:text-base text-slate-600 mb-4 sm:mb-6">Point your camera at an attendee's QR code to check them in or out.</p>

            <!-- Toast container -->
            <div id="toast-container" class="fixed top-4 right-4 z-50"></div>

            <!-- Scanner container – responsive height -->
            <div id="reader" class="w-full h-[60vh] sm:h-[400px] bg-slate-100 rounded-lg overflow-hidden"></div>

            <div id="camera-status" class="mt-3 text-sm text-slate-600"></div>

            <!-- Manual fallback -->
            <div id="manual-fallback" class="hidden mt-4">
                <p class="text-sm text-slate-600 mb-2">Camera not available? Enter registration ID manually:</p>
                <form asp-action="ProcessScan" method="get" class="flex gap-2">
                    <input type="number" name="id" placeholder="Registration ID"
                           class="flex-1 px-3 py-2 border border-slate-300 rounded-lg text-sm" required />
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm hover:bg-indigo-700">
                        Check
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/html5-qrcode/html5-qrcode.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const readerElement = document.getElementById('reader');
            const statusEl = document.getElementById('camera-status');
            const fallbackEl = document.getElementById('manual-fallback');
            const toastContainer = document.getElementById('toast-container');

            if (typeof Html5Qrcode === 'undefined') {
                statusEl.innerText = 'QR scanner library failed to load. Please refresh.';
                fallbackEl.classList.remove('hidden');
                return;
            }

            const html5QrCode = new Html5Qrcode("reader");
            let scanningPaused = false;

            const qrCodeSuccessCallback = (decodedText) => {
                if (scanningPaused) return;
                scanningPaused = true;
                html5QrCode.pause();

                console.log('Scanned URL:', decodedText);

                if (!decodedText.toLowerCase().includes('/staff/processscan/')) {
                    showToast('Invalid QR code: not a check-in URL', 'error');
                    setTimeout(() => {
                        html5QrCode.resume();
                        scanningPaused = false;
                    }, 2000);
                    return;
                }

                fetch(decodedText)
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error ${response.status}: ${response.statusText}`);
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) showToast(data.message, 'success');
                        else showToast(data.message, 'error');
                    })
                    .catch(err => {
                        console.error('Fetch error:', err);
                        showToast('Error: ' + err.message, 'error');
                    })
                    .finally(() => {
                        setTimeout(() => {
                            html5QrCode.resume();
                            scanningPaused = false;
                        }, 2000);
                    });
            };

            // Calculate qrbox size based on container width
            const containerWidth = readerElement.clientWidth;
            const qrboxSize = Math.min(450, containerWidth - 80);
            const qrbox = { width: qrboxSize, height: qrboxSize };

            const config = {
                fps: 10,
                qrbox: qrbox,
                rememberLastUsedCamera: true,
                showTorchButtonIfSupported: true,
                formatsToSupport: [ Html5QrcodeSupportedFormats.QR_CODE ]
            };

            const videoConstraints = { facingMode: "environment" };

            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                statusEl.innerText = 'Camera API not supported by this browser.';
                fallbackEl.classList.remove('hidden');
                return;
            }

            html5QrCode.start(videoConstraints, config, qrCodeSuccessCallback)
                .catch(err => {
                    console.error('Camera error:', err);
                    statusEl.innerText = 'Camera error: ' + (err.message || 'Unable to access camera.');
                    fallbackEl.classList.remove('hidden');
                });

            function showToast(message, type) {
                if (!toastContainer) return;
                const toast = document.createElement('div');
                toast.className = `mb-2 px-3 py-2 rounded-lg text-white shadow-lg ${
                    type === 'success' ? 'bg-green-500' : 'bg-rose-500'
                }`;
                toast.textContent = message;
                toastContainer.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);
            }
        });
    </script>
}